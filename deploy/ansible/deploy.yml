---
- name: Deploy to EKS
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ns: vehicle
    app_name: vehicle-app
    image_latest: "{{ deploy_image | default('docker.io/kiyaye1/vehicle-oop:latest') }}"
    docker_user: "{{ lookup('env','DOCKER_USER') }}"
    docker_pass: "{{ lookup('env','DOCKER_PASS') }}"
    eks_cluster: "{{ lookup('env','EKS_CLUSTER') | default('vehicle-eks') }}"
    aws_region: "{{ lookup('env','AWS_DEFAULT_REGION') | default('us-east-2') }}"

  tasks:
    - name: Configure kubeconfig for EKS
      command: aws eks update-kubeconfig --name {{ eks_cluster }} --region {{ aws_region }}
      changed_when: true

    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/namespace.yaml"

    - name: Ensure Docker Hub pull secret
      shell: |
        kubectl -n {{ ns }} delete secret dockerhub-creds --ignore-not-found
        kubectl -n {{ ns }} create secret docker-registry dockerhub-creds \
          --docker-username='{{ docker_user }}' \
          --docker-password='{{ docker_pass }}' \
          --docker-email='none@example.com'
      changed_when: true

    - name: Apply Service
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/service.yaml"

    - name: Apply Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/deployment.yaml"

    - name: Wait for rollout
      shell: kubectl -n {{ ns }} rollout status deploy/{{ app_name }} --timeout=300s
