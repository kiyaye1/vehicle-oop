---
- name: Deploy to EKS
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ns: vehicle
    app_name: vehicle-app
    image_latest: "{{ deploy_image | default('docker.io/kiyaye1/vehicle-oop:latest') }}"
    docker_user: "{{ lookup('env','DH_USER') | default(lookup('env','DOCKER_USER')) }}"
    docker_pass: "{{ lookup('env','DH_PASS')  | default(lookup('env','DOCKER_PASS')) }}"
    eks_cluster: "{{ lookup('env','EKS_CLUSTER') | default('vehicle-eks') }}"
    aws_region: "{{ lookup('env','AWS_DEFAULT_REGION') | default('us-east-2') }}"
    db_host: "{{ lookup('env','DB_HOST') }}"
    db_user: "{{ lookup('env','DB_USER') | default('system') }}"
    db_pass: "{{ lookup('env','DB_PASSWORD') | default('Eyotekonjo12') }}"
    db_url: "jdbc:oracle:thin:@//{{ db_host }}:1521/XEPDB1"

  tasks:
    - name: Configure kubeconfig for EKS
      command: aws eks update-kubeconfig --name {{ eks_cluster }} --region {{ aws_region }}
      changed_when: true

    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/namespace.yaml"

    - name: Ensure Docker Hub pull secret
      shell: |
        kubectl -n {{ ns }} delete secret dockerhub-creds --ignore-not-found
        kubectl -n {{ ns }} create secret docker-registry dockerhub-creds \
          --docker-username='{{ docker_user }}' \
          --docker-password='{{ docker_pass }}' \
          --docker-email='none@example.com'
      changed_when: true

    - name: Create/Update DB secret (stringData)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: db-secret
            namespace: "{{ ns }}"
          type: Opaque
          stringData:
            SPRING_DATASOURCE_URL: "{{ db_url }}"
            SPRING_DATASOURCE_USERNAME: "{{ db_user }}"
            SPRING_DATASOURCE_PASSWORD: "{{ db_pass }}"
            SPRING_DATASOURCE_DRIVER_CLASS_NAME: "oracle.jdbc.OracleDriver"

    - name: Apply Service
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/service.yaml"

    - name: Apply Deployment
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/deployment.yaml"

    - name: Apply HPA
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../k8s/hpa.yaml"

    - name: Wait for rollout
      shell: kubectl -n {{ ns }} rollout status deploy/{{ app_name }} --timeout=300s
