- hosts: local
  gather_facts: false

  vars:
    kube_ns: vehicle
    aws_region: "{{ lookup('env','AWS_REGION') }}"
    eks_cluster: "{{ lookup('env','EKS_CLUSTER') }}"
    rollout_timeout: "{{ rollout_timeout | default('600') }}"  # numeric seconds only

  tasks:

    - name: 🧭 Configure kubeconfig for EKS
      ansible.builtin.command:
        cmd: aws eks update-kubeconfig --name {{ eks_cluster }} --region {{ aws_region }}
      changed_when: false

    - name: 🧩 Ensure namespace exists
      kubernetes.core.k8s:
        state: present
        src: ../k8s/namespace.yaml

    - name: 📦 Apply Service
      kubernetes.core.k8s:
        state: present
        src: ../k8s/service.yaml

    - name: 🚀 Apply Deployment manifest
      kubernetes.core.k8s:
        state: present
        src: ../k8s/deployment.yaml

    - name: 🔄 Force image update to freshly built tag
      ansible.builtin.command:
        cmd: kubectl -n {{ kube_ns }} set image deploy/vehicle-app vehicle-app={{ deploy_image }}
      register: image_update
      changed_when: "'image updated' in image_update.stdout or image_update.rc == 0"

    - name: 🕒 Wait for rollout to complete (with retries)
      ansible.builtin.command:
        cmd: kubectl -n {{ kube_ns }} rollout status deploy/vehicle-app --timeout={{ rollout_timeout }}s
      register: rollout_result
      retries: 3
      delay: 30
      until: rollout_result.rc == 0
      ignore_errors: true  # continue even if rollout fails (so we can dump logs)

    - name: ❌ Dump pod logs and describe on failure
      when: rollout_result.rc != 0
      block:
        - name: ⚠️ Show pod events
          ansible.builtin.command:
            cmd: kubectl -n {{ kube_ns }} describe pods
          ignore_errors: true

        - name: ⚠️ Show container logs
          ansible.builtin.command:
            cmd: kubectl -n {{ kube_ns }} logs -l app=vehicle-app --tail=100
          ignore_errors: true

        - name: 🚨 Fail task explicitly
          ansible.builtin.fail:
            msg: "Rollout failed — check above pod logs for cause."

    - name: ✅ Verify deployment success
      when: rollout_result.rc == 0
      ansible.builtin.command:
        cmd: kubectl -n {{ kube_ns }} get deploy vehicle-app -o wide
      register: deploy_status
      changed_when: false

    - name: 🟢 Show pod status summary
      when: rollout_result.rc == 0
      ansible.builtin.command:
        cmd: kubectl -n {{ kube_ns }} get pods -o wide
      changed_when: false
